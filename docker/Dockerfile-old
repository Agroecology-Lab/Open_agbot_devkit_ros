# Use the official ROS 2 Humble base
FROM ros:humble-ros-base

# 1. Setup Environment
ENV DEBIAN_FRONTEND=noninteractive
ENV RMW_IMPLEMENTATION=rmw_cyclonedds_cpp

# Define custom paths clearly without referencing PYTHONPATH yet
ENV AG_PATHS="/root/.lizard:/workspace/install/basekit_ui/lib/python3.10/site-packages:/workspace/install/basekit_driver/lib/python3.10/site-packages"
# This syntax prevents the "UndefinedVar" error
ENV PYTHONPATH="${AG_PATHS}"

SHELL ["/bin/bash", "-c"]


# 2. Mirror & System Tooling
#RUN sed -i 's/archive.ubuntu.com/azure.archive.ubuntu.com/g' /etc/apt/sources.list && \ #Alt mirror server

# Fix GPG and Install Core Tooling (Small List + Retry)
RUN for i in {1..5}; do \
    apt-get update -y -o Acquire::AllowInsecureRepositories=true && \
    apt-get install -y --allow-unauthenticated --no-install-recommends \
    ca-certificates curl wget gnupg2 && \
    # This line refreshes the ROS 2 keys specifically
    curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg && \
    break || (echo "Retry $i/5..." && sleep 5); \
    done

#  Minimal AgBot Dependencies
RUN for i in {1..5}; do \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    python3-pip \
    python3-serial \
    ros-humble-gps-msgs \
    ros-humble-usb-cam \
    ros-humble-xacro && \
    break || (echo "Retry $i/5..." && sleep 5); \
    done
    
    
    
    
    

# 3. Robust Dependency Install (With specific missing modules)
# Added: ros-humble-gps-msgs, ros-humble-tf-transformations, python3-transforms3d
RUN for i in {1..5}; do \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    python3-serial udev libasio-dev python3-colcon-common-extensions \
    python3-setuptools python3-wheel python3-transforms3d \
    ros-humble-gps-msgs \
    ros-humble-tf-transformations \
    ros-humble-rtcm-msgs ros-humble-usb-cam ros-humble-xacro \
    ros-humble-nmea-msgs ros-humble-joint-state-publisher \
    ros-humble-robot-state-publisher ros-humble-controller-manager \
    ros-humble-diff-drive-controller ros-humble-twist-mux \
    python3-pymongo \
    ros-humble-interactive-markers \
    ros-humble-navigation2 \
    ros-humble-nav2-msgs \
    ros-humble-rmw-cyclonedds-cpp ros-humble-iceoryx-binding-c && \
    break || (echo "Retry $i/5 failing, waiting..." && sleep 10); \
    done && rm -rf /var/lib/apt/lists/*
    
# Add MongoDB Repository and install dependencies for Topological Navigation
RUN for i in {1..5}; do \
    apt-get update && \
    apt-get install -y --no-install-recommends gnupg curl && \
    curl -fsSL https://www.mongodb.org/static/pgp/server-6.0.asc | \
    gpg --dearmor -o /usr/share/keyrings/mongodb-server-6.0.gpg && \
    echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/ubuntu jammy/mongodb-org/6.0 multiverse" | \
    tee /etc/apt/sources.list.d/mongodb-org-6.0.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    mongodb-org-server \
    mongodb-org-shell \
    python3-pymongo \
    ros-humble-interactive-markers \
    ros-humble-navigation2 \
    ros-humble-nav2-msgs && \
    apt-get clean && rm -rf /var/lib/apt/lists    
    
    
    
    


# 4. Web UI & Logic Dependencies (Force bypass signature errors)
RUN apt-get update -o Acquire::AllowInsecureRepositories=true || true && \
    apt-get install -y --allow-unauthenticated --no-install-recommends python3-pip curl gnupg2 && \
    # Manually re-add the ROS key because the one in the base image is likely expired
    curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key | apt-key add - && \
    pip3 install --upgrade pip && \
    pip3 install nicegui lizard    
    
    
    
    
    
    

# 5. Lizard Espresso Firmware
RUN mkdir -p /root/.lizard && cd /root && \
    LATEST_TAG=$(curl -s https://api.github.com/repos/zauberzeug/lizard/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")') && \
    wget -O lizard.zip "https://github.com/zauberzeug/lizard/releases/download/${LATEST_TAG}/lizard_firmware_and_devtools_${LATEST_TAG}_esp32.zip" && \
    unzip -o lizard.zip -d /root/.lizard && rm lizard.zip && \
    chmod +x /root/.lizard/espresso.py

# 6. Workspace Setup
WORKDIR /workspace
COPY ./src ./src

# 7. Staged Build Sequence (Prevents C++/Python Cross-build Failures)
# We build dependencies first, source them, then build the rest.
RUN . /opt/ros/humble/setup.sh && \
    colcon build --symlink-install --packages-select ublox_serialization && \
    . install/setup.sh && \
    colcon build --symlink-install --packages-select ublox_msgs && \
    . install/setup.sh && \
    colcon build --symlink-install --parallel-workers 1

# 8. Environment Configuration
RUN echo "source /opt/ros/humble/setup.bash" >> /root/.bashrc && \
    echo "source /workspace/install/setup.bash" >> /root/.bashrc

# 9. Generic Entrypoint

# Added by fix.py: Universal hardware script access
RUN mkdir -p /opt/lizard && cp -r /root/.lizard/* /opt/lizard/ || true
RUN chmod -R 755 /opt/lizard
CMD ["/bin/bash"]

# Source the workspace
RUN echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc
RUN echo "source /home/user/open_agbot_ws/install/setup.bash" >> ~/.bashrc
